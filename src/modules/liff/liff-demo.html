<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE ç™»å…¥æ¸¬è©¦</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #00B900;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #009900;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .success {
            color: green;
            margin-top: 10px;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>LINE ç™»å…¥æ¸¬è©¦</h2>
        
        <div class="info">
            <strong>ğŸ”’ å®‰å…¨ç™»å…¥èªªæ˜ï¼š</strong><br>
            1. è¼¸å…¥èªè­‰ç¢¼ï¼ˆè‡³å°‘6ä½æ•¸å­—ï¼‰<br>
            2. é»æ“Šã€Œä½¿ç”¨èªè­‰ç¢¼ç™»å…¥ã€<br>
            3. ç³»çµ±æœƒä½¿ç”¨ access token å‘ LINE Platform é©—è­‰æ‚¨çš„èº«ä»½<br>
            4. æœå‹™ç«¯ç›´æ¥å¾ LINE Platform ç²å–æ‚¨çš„çœŸå¯¦è³‡æ–™<br>
            <br>
            <strong>ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§ï¼š</strong><br>
            â€¢ å®¢æˆ¶ç«¯åªç™¼é€ access tokenï¼Œä¸ç™¼é€ç”¨æˆ¶è³‡æ–™<br>
            â€¢ æœå‹™ç«¯å‘ LINE Platform é©—è­‰ token æœ‰æ•ˆæ€§<br>
            â€¢ ç”¨æˆ¶è³‡æ–™ç›´æ¥å¾ LINE Platform ç²å–ï¼Œç¢ºä¿çœŸå¯¦æ€§<br>
            <br>
            <strong>å¿«é€Ÿæ¸¬è©¦èªè­‰ç¢¼ï¼š</strong><br>
            <button onclick="setAuthenticationCode('123456')" style="background-color: #f0f0f0; color: #333; padding: 5px 10px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; margin: 2px;">123456</button>
            <button onclick="setAuthenticationCode('888888')" style="background-color: #f0f0f0; color: #333; padding: 5px 10px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; margin: 2px;">888888</button>
            <button onclick="setAuthenticationCode('999999')" style="background-color: #f0f0f0; color: #333; padding: 5px 10px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; margin: 2px;">999999</button>
        </div>
        
        <div id="loginSection">
            <div class="form-group">
                <label for="authenticationCode">èªè­‰ç¢¼ï¼š</label>
                <input type="text" id="authenticationCode" placeholder="è«‹è¼¸å…¥èªè­‰ç¢¼ï¼ˆä¾‹å¦‚ï¼š123456ï¼‰" maxlength="20" required>
            </div>
            
            <button onclick="loginWithInvite()">ä½¿ç”¨èªè­‰ç¢¼ç™»å…¥</button>
            <button onclick="logout()" style="background-color: #ff4444;">ç™»å‡º</button>
        </div>
        
        <div id="message"></div>
        
        <div id="result" style="display: none; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
            <h3>ç™»å…¥çµæœ</h3>
            <p><strong>JWT Token:</strong> <span id="jwtToken"></span></p>
            <p><strong>ç”¨æˆ¶åç¨±:</strong> <span id="userName"></span></p>
            <p><strong>ç”¨æˆ¶ID:</strong> <span id="userId"></span></p>
            <p><strong>æ˜¯å¦æ–°ç”¨æˆ¶:</strong> <span id="isNewUser"></span></p>
        </div>

        <!-- é€£çµæˆåŠŸé é¢ -->
        <div id="successPage" style="display: none; margin-top: 20px; padding: 20px; background: #e8f5e8; border-radius: 10px; text-align: center;">
            <div style="font-size: 48px; color: #4CAF50; margin-bottom: 20px;">âœ…</div>
            <h2 style="color: #4CAF50; margin-bottom: 15px;">é€£çµæˆåŠŸï¼</h2>
            <p style="color: #666; margin-bottom: 20px;">æ‚¨çš„ LINE å¸³è™Ÿå·²æˆåŠŸç¶å®šåˆ°ç³»çµ±</p>
            
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>ç¶å®šè³‡è¨Šï¼š</strong></p>
                <p>LINE ç”¨æˆ¶ï¼š<span id="successUserName"></span></p>
                <p>ç”¨æˆ¶ IDï¼š<span id="successUserId"></span></p>
                <p>ç¶å®šæ™‚é–“ï¼š<span id="bindTime"></span></p>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="goToMainApp()" style="background-color: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-right: 10px;">
                    é€²å…¥ä¸»æ‡‰ç”¨
                </button>
                <button onclick="shareSuccess()" style="background-color: #2196F3; color: white; padding: 12px 24px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-right: 10px;">
                    åˆ†äº«çµ¦æœ‹å‹
                </button>
                <button onclick="restartProcess()" style="background-color: #FF9800; color: white; padding: 12px 24px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                    é‡æ–°é–‹å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        const liffId = '2008316850-kN5g1q7N';
        
        // å¿«é€Ÿè¨­ç½®èªè­‰ç¢¼çš„å‡½æ•¸
        function setAuthenticationCode(code) {
            document.getElementById('authenticationCode').value = code;
            console.log(`è¨­ç½®èªè­‰ç¢¼: ${code}`);
        }
        
        // åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: liffId });
                console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                
                if (liff.isLoggedIn()) {
                    console.log('å·²ç™»å…¥');
                    await showUserInfo();
                } else {
                    console.log('æœªç™»å…¥');
                    showLoginButton();
                }
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                showMessage('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åœ¨ LINE ä¸­é–‹å•Ÿæ­¤é é¢', 'error');
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        async function showUserInfo() {
            try {
                // é€é LIFF å–å¾—ä½¿ç”¨è€…è³‡æ–™
                const profile = await liff.getProfile();

                console.log('ç”¨æˆ¶è³‡è¨Š (liff.getProfile):', profile);
                document.getElementById('userId').textContent = profile.userId;
                document.getElementById('userName').textContent = profile.displayName;
            } catch (error) {
                console.error('å–å¾—ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
        function showLoginButton() {
            const loginSection = document.getElementById('loginSection');
            loginSection.innerHTML = `
                <h3>è«‹å…ˆç™»å…¥ LINE</h3>
                <p>æ‚¨éœ€è¦å…ˆç™»å…¥ LINE æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½</p>
                <button onclick="loginWithLine()">ä½¿ç”¨ LINE ç™»å…¥</button>
            `;
        }

        // LINE ç™»å…¥
        function loginWithLine() {
            liff.login();
        }

        // ç™»å‡º
        function logout() {
            liff.logout();
        }

        // ä½¿ç”¨èªè­‰ç¢¼ç™»å…¥ï¼ˆå®‰å…¨ç‰ˆæœ¬ - åªç™¼é€ access tokenï¼‰
        async function loginWithInvite() {
            const authenticationCode = document.getElementById('authenticationCode').value.trim();
            
            if (!authenticationCode || authenticationCode.length < 6) {
                showMessage('è«‹è¼¸å…¥è‡³å°‘6ä½æ•¸å­—çš„èªè­‰ç¢¼', 'error');
                return;
            }

            try {
                showMessage('æ­£åœ¨å®‰å…¨ç™»å…¥...', 'success');
                
                // åªå–å¾— access tokenï¼Œä¸ç™¼é€ç”¨æˆ¶è³‡æ–™ï¼ˆæ›´å®‰å…¨ï¼‰
                const accessToken = liff.getAccessToken();

                console.log('[å®‰å…¨æ¨¡å¼] åªç™¼é€ access token åˆ°æœå‹™ç«¯é€²è¡Œé©—è­‰');
                console.log('Access Token å­˜åœ¨:', !!accessToken);
                console.log('Access Token:', accessToken);
                
                if (!accessToken) {
                    showMessage('ç„¡æ³•å–å¾— LINE æˆæ¬Šï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                    return;
                }
                
                const response = await fetch('/app-api/line-auth/login-with-invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        authenticationCode: authenticationCode,
                        accessToken: accessToken // ä¸»è¦é©—è­‰æ–¹å¼
                    })
                });
                
                const result = await response.json();
                console.log('API å›æ‡‰:', result);
                
                if (result.status === 200 && result.data) {
                    showMessage('å®‰å…¨ç™»å…¥æˆåŠŸï¼', 'success');
                    showSuccessPage(result.data);
                } else {
                    console.error('ç™»å…¥å¤±æ•—:', result);
                    showMessage(result.message || result.data || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                showMessage('ç™»å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // é¡¯ç¤ºçµæœ
        function showResult(data) {
            document.getElementById('jwtToken').textContent = data.jwtToken.substring(0, 50) + '...';
            document.getElementById('userName').textContent = data.userProfile.displayName;
            document.getElementById('userId').textContent = data.userProfile.userId;
            document.getElementById('isNewUser').textContent = data.isNewUser ? 'æ˜¯' : 'å¦';
            document.getElementById('result').style.display = 'block';
        }

        // é¡¯ç¤ºæˆåŠŸé é¢
        function showSuccessPage(data) {
            // éš±è—ç™»å…¥å€åŸŸå’Œçµæœå€åŸŸ
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            
            // é¡¯ç¤ºæˆåŠŸé é¢
            document.getElementById('successPage').style.display = 'block';
            
            // å¡«å…¥æˆåŠŸè³‡è¨Š
            document.getElementById('successUserName').textContent = data.userProfile.displayName;
            document.getElementById('successUserId').textContent = data.userProfile.userId;
            document.getElementById('bindTime').textContent = new Date().toLocaleString('zh-TW');
            
            // å„²å­˜ JWT token åˆ° localStorage
            localStorage.setItem('jwt_token', data.jwtToken);
            localStorage.setItem('user_profile', JSON.stringify(data.userProfile));
            
            console.log('é€£çµæˆåŠŸï¼ç”¨æˆ¶è³‡è¨Šå·²å„²å­˜');
        }

        // é€²å…¥ä¸»æ‡‰ç”¨
        function goToMainApp() {
            // é€™è£¡å¯ä»¥é‡å®šå‘åˆ°æ‚¨çš„ä¸»æ‡‰ç”¨
            // ä¾‹å¦‚ï¼šwindow.location.href = 'https://your-main-app.com';
            
            // æš«æ™‚é¡¯ç¤ºè¨Šæ¯
            showMessage('æ­£åœ¨é‡å®šå‘åˆ°ä¸»æ‡‰ç”¨...', 'success');
            
            // æ¨¡æ“¬é‡å®šå‘ï¼ˆæ‚¨å¯ä»¥æ›¿æ›ç‚ºå¯¦éš›çš„ä¸»æ‡‰ç”¨ URLï¼‰
            setTimeout(() => {
                alert('é€™è£¡æœƒé‡å®šå‘åˆ°æ‚¨çš„ä¸»æ‡‰ç”¨\n\nç›®å‰æ˜¯æ¸¬è©¦æ¨¡å¼ï¼Œè«‹è¨­å®šå¯¦éš›çš„ä¸»æ‡‰ç”¨ URL');
            }, 1000);
        }

        // åˆ†äº«æˆåŠŸ
        function shareSuccess() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([
                    {
                        type: 'text',
                        text: 'æˆ‘å·²ç¶“æˆåŠŸé€£çµåˆ°ç³»çµ±äº†ï¼æ‚¨ä¹Ÿå¯ä»¥é€éé‚€è«‹ç¢¼ä¾†é€£çµæ‚¨çš„å¸³è™Ÿã€‚'
                    }
                ]).then(() => {
                    console.log('åˆ†äº«æˆåŠŸ');
                }).catch((error) => {
                    console.error('åˆ†äº«å¤±æ•—:', error);
                    showMessage('åˆ†äº«åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨', 'error');
                });
            } else {
                // å¦‚æœç„¡æ³•ä½¿ç”¨åˆ†äº«åŠŸèƒ½ï¼Œè¤‡è£½åˆ°å‰ªè²¼æ¿
                const shareText = 'æˆ‘å·²ç¶“æˆåŠŸé€£çµåˆ°ç³»çµ±äº†ï¼æ‚¨ä¹Ÿå¯ä»¥é€éé‚€è«‹ç¢¼ä¾†é€£çµæ‚¨çš„å¸³è™Ÿã€‚';
                navigator.clipboard.writeText(shareText).then(() => {
                    showMessage('åˆ†äº«æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼æ¿', 'success');
                }).catch(() => {
                    showMessage('ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼æ¿', 'error');
                });
            }
        }

        // é‡æ–°é–‹å§‹æµç¨‹
        function restartProcess() {
            // æ¸…é™¤å„²å­˜çš„è³‡æ–™
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_profile');
            
            // éš±è—æˆåŠŸé é¢
            document.getElementById('successPage').style.display = 'none';
            
            // é¡¯ç¤ºç™»å…¥å€åŸŸ
            document.getElementById('loginSection').style.display = 'block';
            
            // æ¸…ç©ºèªè­‰ç¢¼è¼¸å…¥æ¡†
            document.getElementById('authenticationCode').value = '';
            
            // æ¸…ç©ºè¨Šæ¯
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = '';
            
            console.log('å·²é‡æ–°é–‹å§‹èªè­‰ç¢¼ç™»å…¥æµç¨‹');
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', initializeLiff);
    </script>
</body>
</html>
